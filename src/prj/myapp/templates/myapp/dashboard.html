{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center">Tableau de Bord des Prix</h2>

    <!-- S√©lection du Produit et de la P√©riode -->
    <div class="row mb-3">
        <div class="col-md-6">
            <label for="product-select">S√©lectionnez un produit :</label>
            <select id="product-select" class="form-control">
                <option value="">-- Choisissez un produit --</option>
                {% for product in products %}
                    <option value="{{ product.id }}">{{ product.nom }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-6">
            <label for="timeframe-select">Regrouper par :</label>
            <select id="timeframe-select" class="form-control">
                <option value="monthly">Mensuelle</option>
                <option value="yearly">Annuelle</option>
                <option value="daily">Journali√®re (d√©sactiv√©)</option>
            </select>
        </div>
    </div>

    <!-- üìà Graphique d'√âvolution des Prix -->
    <div class="chart-container mt-4" style="position: relative; height: 50vh; width: 80%;">
        <canvas id="lineChart"></canvas>
    </div>

    <!-- üìä Graphiques en Barres -->
    <div class="row mt-5">
        <div class="col-md-6">
            <h4 class="text-center">√âvolution des Prix Moyens (Produit S√©lectionn√©)</h4>
            <div class="chart-container" style="position: relative; height: 40vh; width: 100%;">
                <canvas id="barChartProduct"></canvas>
            </div>
        </div>

        <div class="col-md-6">
            <h4 class="text-center">√âvolution Moyenne des Prix de Tous les Produits</h4>
            <div class="chart-container" style="position: relative; height: 40vh; width: 100%;">
                <canvas id="barChartAllProducts"></canvas>
            </div>
        </div>
    </div>

    <!-- ü•ß Graphique en Camembert -->
    <div class="container mt-5">
        <h2 class="text-center">R√©partition des Produits par Cat√©gorie</h2>
        <div class="chart-container mt-3" style="position: relative; height: 40vh; width: 50%;">
            <canvas id="pieChartCategories"></canvas>
        </div>
    </div>
</div>

<!-- üìå Inclure Charts.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const productSelect = document.getElementById("product-select");
    const timeframeSelect = document.getElementById("timeframe-select");
    const ctxLine = document.getElementById("lineChart").getContext("2d");
    let lineChartInstance = null;
    
    function updateLineChart(productId, aggregation) {
        if (!productId || aggregation === "daily") {
            if (lineChartInstance) lineChartInstance.destroy();
            return;
        }

        fetch(`/get-product-price-data/?product_id=${productId}&aggregation=${aggregation}`)
            .then(response => response.json())
            .then(data => {
                if (lineChartInstance) {
                    lineChartInstance.destroy();
                }
                lineChartInstance = new Chart(ctxLine, {
                    type: "line",
                    data: {
                        labels: data.dates,
                        datasets: [{
                            label: `√âvolution du prix de ${data.product_name}`,
                            data: data.prices,
                            borderColor: "#007bff",
                            backgroundColor: "rgba(54, 162, 235, 0.2)",
                            pointRadius: 5,
                            pointBackgroundColor: "#ff0000",
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { font: { size: 14 } } }
                        },
                        scales: {
                            x: { ticks: { autoSkip: true, maxTicksLimit: 10 } }
                        }
                    }
                });
            });
    }

    productSelect.addEventListener("change", function () {
        updateLineChart(this.value, timeframeSelect.value);
        updateBarChartProduct(this.value);
    });

    timeframeSelect.addEventListener("change", function () {
        updateLineChart(productSelect.value, this.value);
    });

    // üìä Charger les donn√©es pour le Bar Chart - Produit S√©lectionn√©
    function updateBarChartProduct(productId) {
        if (!productId) return;

        fetch(`/charts/bar-product-prices/?product_id=${productId}`)
            .then(response => response.json())
            .then(data => {
                const ctxBarProduct = document.getElementById("barChartProduct").getContext("2d");
                new Chart(ctxBarProduct, {
                    type: "bar",
                    data: {
                        labels: data.dates,
                        datasets: [{
                            label: `Prix Moyen Mensuel (${data.product_name})`,
                            data: data.prices,
                            backgroundColor: "rgb(11, 207, 233)"
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            });
    }

    // üìä Charger les donn√©es pour le Bar Chart - Tous les Produits
    fetch("/charts/bar-all-products/")
        .then(response => response.json())
        .then(data => {
            const ctxBarAll = document.getElementById("barChartAllProducts").getContext("2d");
            new Chart(ctxBarAll, {
                type: "bar",
                data: {
                    labels: data.dates,
                    datasets: [{
                        label: "Prix Moyen Mensuel (Tous les Produits)",
                        data: data.prices,
                        backgroundColor: "rgba(25, 99, 132, 0.6)"
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        });

    // ü•ß Charger les donn√©es pour le Pie Chart - R√©partition des Produits par Cat√©gorie
    fetch("/charts/pie-product-categories/")
        .then(response => response.json())
        .then(data => {
            const ctxPie = document.getElementById("pieChartCategories").getContext("2d");
            new Chart(ctxPie, {
                type: "pie",
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: "Nombre de Produits",
                        data: data.values,
                        backgroundColor: [
                            "rgba(255, 99, 132, 0.6)",
                            "rgba(54, 162, 235, 0.6)",
                            "rgba(255, 206, 86, 0.6)",
                            "rgba(75, 192, 192, 0.6)",
                            "rgba(153, 102, 255, 0.6)",
                            "rgba(255, 159, 64, 0.6)"
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: "right" }
                    }
                }
            });
        });
});
</script>

{% endblock %}
